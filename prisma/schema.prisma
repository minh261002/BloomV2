// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

enum Role {
  ADMIN
  USER
}

model User {
  id            String        @id
  name          String        @db.Text
  email         String
  emailVerified Boolean       @default(false)
  image         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  role          Role          @default(USER)
  banned        Boolean?      @default(false)
  banReason     String?       @db.Text
  banExpires    DateTime?
  sessions      Session[]
  accounts      Account[]
  userAddresses UserAddress[]

  @@unique([email])
  @@map("user")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  ipAddress      String?  @db.Text
  userAgent      String?  @db.Text
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?  @db.Text

  @@unique([token])
  @@index([userId(length: 191)])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String    @db.Text
  providerId            String    @db.Text
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?   @db.Text
  refreshToken          String?   @db.Text
  idToken               String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?   @db.Text
  password              String?   @db.Text
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId(length: 191)])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String   @db.Text
  value      String   @db.Text
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier(length: 191)])
  @@map("verification")
}

enum AddressType {
  HOME
  WORK
  OTHER
}

model UserAddress {
  id           String      @id
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  address      String      @db.Text
  provinceCode String      @map("province_code")
  wardCode     String      @map("ward_code")
  province     Province    @relation(fields: [provinceCode], references: [provinceCode], onDelete: Cascade)
  ward         Ward        @relation(fields: [wardCode], references: [wardCode], onDelete: Cascade)
  type         AddressType @default(HOME)
  isDefault    Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([userId])
  @@index([provinceCode])
  @@index([wardCode])
  @@map("user_addresses")
}

model Province {
  id           BigInt    @id
  provinceCode String    @unique @map("province_code") @db.VarChar(2)
  name         String    @db.VarChar(255)
  shortName    String    @map("short_name") @db.VarChar(255)
  code         String    @db.VarChar(5)
  placeType    String    @map("place_type") @db.VarChar(255)
  country      String    @db.VarChar(10)
  createdAt    DateTime? @map("created_at")
  updatedAt    DateTime? @map("updated_at")

  wards         Ward[]
  userAddresses UserAddress[]

  @@map("provinces")
}

model Ward {
  id           BigInt    @id @default(autoincrement())
  wardCode     String    @unique @map("ward_code") @db.VarChar(6)
  name         String    @db.VarChar(255)
  provinceCode String    @map("province_code") @db.VarChar(2)
  createdAt    DateTime? @map("created_at")
  updatedAt    DateTime? @map("updated_at")

  province      Province      @relation(fields: [provinceCode], references: [provinceCode], onDelete: Cascade)
  userAddresses UserAddress[]

  @@index([provinceCode])
  @@map("wards")
}

enum ActiveStatus {
  ACTIVE
  INACTIVE
}

model Category {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?      @db.Text
  image       String?      @db.Text
  featured    Boolean      @default(false)
  status      ActiveStatus @default(ACTIVE)
  sortOrder   Int          @default(0)

  // SEO
  metaTitle       String? @db.Text
  metaDescription String? @db.Text
  metaKeywords    String? @db.Text

  // Self-referencing for subcategories
  parentId String?
  parent   Category?  @relation("CategoryToSubcategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children Category[] @relation("CategoryToSubcategories")

  collections       Collection[]
  productCategories ProductCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([status])
  @@index([featured])
  @@index([slug])
  @@map("categories")
}

model Collection {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?      @db.Text
  image       String?      @db.Text
  featured    Boolean      @default(false)
  status      ActiveStatus @default(ACTIVE)
  sortOrder   Int          @default(0)

  // SEO
  metaTitle       String? @db.Text
  metaDescription String? @db.Text
  metaKeywords    String? @db.Text

  // Relationships
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  products   Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([status])
  @@index([featured])
  @@index([slug])
  @@map("collections")
}

// ==================== INVENTORY MANAGEMENT ====================

enum SupplierStatus {
  ACTIVE
  INACTIVE
}

model Supplier {
  id          String         @id @default(uuid())
  name        String
  code        String         @unique
  email       String?
  phone       String?
  address     String?        @db.Text
  taxCode     String?        @map("tax_code")
  website     String?
  contactName String?        @map("contact_name")
  status      SupplierStatus @default(ACTIVE)
  notes       String?        @db.Text

  purchaseOrders PurchaseOrder[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@index([status])
  @@map("suppliers")
}

enum PurchaseOrderStatus {
  DRAFT
  ORDERED
  RECEIVED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIAL
  PAID
}

model PurchaseOrder {
  id         String @id @default(uuid())
  code       String @unique
  supplierId String @map("supplier_id")

  // Amounts
  totalAmount Decimal @map("total_amount") @db.Decimal(12, 2)
  paidAmount  Decimal @default(0) @map("paid_amount") @db.Decimal(12, 2)

  // Status
  status        PurchaseOrderStatus @default(DRAFT)
  paymentStatus PaymentStatus       @default(UNPAID) @map("payment_status")

  // Dates
  orderDate    DateTime  @map("order_date")
  receivedDate DateTime? @map("received_date")

  // Notes
  notes String? @db.Text

  // Relationships
  supplier Supplier            @relation(fields: [supplierId], references: [id])
  items    PurchaseOrderItem[]
  payments PurchasePayment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@index([supplierId])
  @@index([status])
  @@index([paymentStatus])
  @@index([orderDate])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String  @id @default(uuid())
  purchaseOrderId String  @map("purchase_order_id")
  productId       String  @map("product_id")
  variantId       String? @map("variant_id")

  // Quantities
  quantity    Int
  receivedQty Int @default(0) @map("received_qty")

  // Pricing
  unitPrice  Decimal @map("unit_price") @db.Decimal(10, 2)
  totalPrice Decimal @map("total_price") @db.Decimal(12, 2)

  purchaseOrder PurchaseOrder   @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product         @relation(fields: [productId], references: [id])
  variant       ProductVariant? @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([purchaseOrderId])
  @@index([productId])
  @@index([variantId])
  @@map("purchase_order_items")
}

model PurchasePayment {
  id              String @id @default(uuid())
  purchaseOrderId String @map("purchase_order_id")

  amount      Decimal  @db.Decimal(12, 2)
  paymentDate DateTime @map("payment_date")
  method      String?
  reference   String?
  notes       String?  @db.Text

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([purchaseOrderId])
  @@map("purchase_payments")
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
}

model StockMovement {
  id        String  @id @default(uuid())
  productId String  @map("product_id")
  variantId String? @map("variant_id")

  type      StockMovementType
  quantity  Int
  reference String?
  notes     String?           @db.Text

  // Snapshot of stock before this movement
  stockBefore Int @map("stock_before")
  stockAfter  Int @map("stock_after")

  product Product         @relation(fields: [productId], references: [id])
  variant ProductVariant? @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([productId])
  @@index([variantId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model Brand {
  id          String       @id @default(uuid())
  name        String
  slug        String       @unique
  description String?      @db.Text
  logo        String?      @db.Text
  website     String?
  featured    Boolean      @default(false)
  status      ActiveStatus @default(ACTIVE)
  sortOrder   Int          @default(0)

  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([featured])
  @@index([status])
  @@map("brands")
}

enum ProductType {
  SIMPLE
  VARIABLE
}

model Product {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String? @db.Text
  shortDesc   String? @map("short_desc") @db.Text

  // Type & Pricing
  type         ProductType @default(SIMPLE)
  price        Decimal     @default(0) @db.Decimal(10, 2)
  comparePrice Decimal?    @map("compare_price") @db.Decimal(10, 2)
  costPrice    Decimal?    @map("cost_price") @db.Decimal(10, 2)

  // Inventory
  sku        String? @unique
  barcode    String?
  trackStock Boolean @default(true) @map("track_stock")
  stock      Int     @default(0)
  lowStock   Int     @default(10) @map("low_stock")

  // Status & Visibility
  status   ActiveStatus @default(ACTIVE)
  featured Boolean      @default(false)

  // Relationships
  brandId      String? @map("brand_id")
  collectionId String? @map("collection_id")

  brand      Brand?      @relation(fields: [brandId], references: [id], onDelete: SetNull)
  collection Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)

  // SEO
  metaTitle       String? @map("meta_title") @db.Text
  metaDescription String? @map("meta_description") @db.Text
  metaKeywords    String? @map("meta_keywords") @db.Text

  // Relations
  images             ProductImage[]
  variants           ProductVariant[]
  productCategories  ProductCategory[]
  purchaseOrderItems PurchaseOrderItem[]
  stockMovements     StockMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug(length: 191)])
  @@index([status])
  @@index([featured])
  @@index([brandId])
  @@index([collectionId])
  @@index([type])
  @@index([sku(length: 191)])
  @@map("products")
}

// Many-to-many relationship between Product and Category
model ProductCategory {
  id         String @id @default(uuid())
  productId  String @map("product_id")
  categoryId String @map("category_id")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@unique([productId, categoryId])
  @@index([productId])
  @@index([categoryId])
  @@map("product_categories")
}

model ProductImage {
  id        String  @id @default(uuid())
  productId String  @map("product_id")
  url       String  @db.Text
  alt       String?
  sortOrder Int     @default(0) @map("sort_order")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([productId])
  @@map("product_images")
}

model ProductVariant {
  id        String @id @default(uuid())
  productId String @map("product_id")

  // Variant Info
  name    String?
  sku     String?
  barcode String?

  // Pricing
  price        Decimal  @db.Decimal(10, 2)
  comparePrice Decimal? @map("compare_price") @db.Decimal(10, 2)
  costPrice    Decimal? @map("cost_price") @db.Decimal(10, 2)

  // Inventory
  stock Int     @default(0)
  image String? @db.Text

  // Options (JSON format: {"size": "M", "color": "Red"})
  options String @db.Text

  product            Product             @relation(fields: [productId], references: [id], onDelete: Cascade)
  purchaseOrderItems PurchaseOrderItem[]
  stockMovements     StockMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@index([sku(length: 191)])
  @@map("product_variants")
}
